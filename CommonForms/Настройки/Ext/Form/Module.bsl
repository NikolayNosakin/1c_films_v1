&НаКлиенте
Процедура kinopoisk_unofficial_api_tokenПриИзменении(Элемент)
	УстановитьЗначениеКонстанты("kinopoisk_unofficial_api_token", kinopoisk_unofficial_api_token);
	УстановитьЗначениеКонстанты("ИспользуетсяЗаполнениеИзКинопоискаПоАПИ", НЕ kinopoisk_unofficial_api_token = "");
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	kinopoisk_unofficial_api_token = Константы.kinopoisk_unofficial_api_token.Получить();
	Стиль = Константы.СтильОформления.Получить();
КонецПроцедуры

&НаСервере
Процедура УстановитьЗначениеКонстанты(ИмяКонстанты, ЗначениеКонстанты)
	Константы[ИмяКонстанты].Установить(ЗначениеКонстанты);
КонецПроцедуры

&НаКлиенте
Процедура СтильПриИзменении(Элемент)
	
	УстановитьЗначениеКонстанты("СтильОформления", Стиль);
	Оповещение = Новый ОписаниеОповещения("ПослеЗакрытияВопроса", ЭтотОбъект);	
	ПоказатьВопрос(Оповещение, "Для применения нужно перезапустить программу. Перезапустить?", РежимДиалогаВопрос.ДаНет,0, КодВозвратаДиалога.Да);
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗакрытияВопроса(Результат, Параметры) Экспорт
	
	Если Результат = КодВозвратаДиалога.Да Тогда
		ЗавершитьРаботуСистемы(Ложь, Истина);
	КонецЕсли;	
	
КонецПроцедуры

&НаКлиенте
Процедура СохранитьДанные(Команда)

	ПоказатьДлительнуюОперацию(Истина);	
	Оповещение = Новый ОписаниеОповещения("ВыборФайлаСохранение", ЭтотОбъект);
	Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.ВыборКаталога); 
	Диалог.Показать(Оповещение);
	
КонецПроцедуры

&НаКлиенте
Процедура ВыборФайлаСохранение(ВыбранныеФайлы, ДополнительныеПараметры) Экспорт
	
	Если ВыбранныеФайлы <> Неопределено Тогда		
		ПутьКФайлу = ВыбранныеФайлы[0];
		ИмяФайла = "Movie_backup_"+Формат(ТекущаяДата(),"ДФ=yyyy.MM.dd")+"_"+Формат(ТекущаяДата(),"ДФ=чч.мм.сс")+".json";
		Данные = СохранениеВосстановлениеДанныхСервер.Сохранить();
		ТекДок = Новый ЗаписьТекста(ПутьКФайлу + "\" + ИмяФайла);
		ТекДок.ЗаписатьСтроку(Данные);
		ТекДок.Закрыть();
		Сообщить("Сохранение данных завершено. Файл " + ИмяФайла + " сохранен.",СтатусСообщения.Внимание);
	КонецЕсли;	
	ПоказатьДлительнуюОперацию(Ложь);  
	
КонецПроцедуры

&НаКлиенте
Процедура ПоказатьДлительнуюОперацию(Показать)
	
	Элементы.kinopoisk_unofficial_api_token.Видимость = НЕ Показать;
	Элементы.ВосстановитьДанные.Видимость = НЕ Показать;
	Элементы.СохранитьДанные.Видимость = НЕ Показать; 
	Элементы.Стиль.Видимость = НЕ Показать;
	Элементы.ДлительнаяОперация.Видимость = Показать;
	
КонецПроцедуры

&НаКлиенте
Процедура ВосстановитьДанные(Команда)
	
	ПоказатьДлительнуюОперацию(Истина);	
	Оповещение = Новый ОписаниеОповещения("ВыборФайлаЧтение", ЭтотОбъект); 
	Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	Диалог.МножественныйВыбор = Ложь; 
	Диалог.Показать(Оповещение);
	
КонецПроцедуры

&НаКлиенте
Процедура ВыборФайлаЧтение(ВыбранныеФайлы, ДополнительныеПараметры) Экспорт
	
	Если ВыбранныеФайлы <> Неопределено Тогда		
		ПутьКФайлу = ВыбранныеФайлы[0];
		ЧТ = Новый ЧтениеТекста(ПутьКФайлу);
		Текст = ЧТ.Прочитать();
		СохранениеВосстановлениеДанныхСервер.Восстановить(Текст);
		Сообщить("Восстановление данных завершено.",СтатусСообщения.Внимание);
	КонецЕсли;	
	ПоказатьДлительнуюОперацию(Ложь);	
	 
КонецПроцедуры